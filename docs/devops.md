# DevOps

- [DevOps](#devops)
  - [Branching Strategy](#branching-strategy)
    - [One Feature](#one-feature)
    - [Multiple Features](#multiple-features)
    - [Production Hotfix](#production-hotfix)
  - [Terraform](#terraform)
  - [Azure Data Factory (ADF)](#azure-data-factory-adf)
    - [Files](#files)
    - [SQL](#sql)
  - [Databricks](#databricks)
    - [Notebooks](#notebooks)
    - [Pipelines](#pipelines)
  - [Workflows](#workflows)
    - [Deployment Workflow](#deployment-workflow)
  - [Checkov Terraform Policies](#checkov-terraform-policies)

## Branching Strategy

### One Feature

![One Feature](./img/pr-one-feature.png)

1. :large_blue_circle: Developer creates `feature-x` branch from `main`
2. :large_blue_circle: Developer clones `feature-x` branch to their local machine
3. :large_blue_circle: Developer makes changes to the source code
4. :large_blue_circle: Developer regularly pulls changes from `main` to `feature-x`
5. :large_blue_circle: Developer regularly commits and pushes changes to `feature-x`
6. :large_blue_circle: Developer creates a pull request to merge `feature-x` into `main`
7. :large_blue_circle: CI workflows are triggered to validate, test, and build the source code
8. :large_blue_circle: Reviewer receives a notification to review the pull request based on the `CODEOWNERS` file
9. :large_blue_circle: Reviewer reviews the pull request and approves it
10. :large_blue_circle: `feature-x` is merged into `main`
11. :large_blue_circle: `feature-x` branch is deleted
12. :large_blue_circle: CD workflows are triggered
13. :large_blue_circle: A release/tag is created

:rotating_light: If the feature branch is not merged into main for a long time, the developer should regularly pull changes from main to the feature branch to avoid merge conflicts.

:rotating_light: Once the pull request is created, a workflow is triggered to check if the feature branch is up to date with main. If the feature branch is not up to date with main, the workflow will fail and the developer will need to pull changes from main to the feature branch and push the changes to the feature branch.

---

### Multiple Features

![Multiple Features](./img/pr-multiple-features.png)

Developer #1 is working on `feature-x` branch and Developer #2 is working on `feature-y` branch.

1. :large_blue_circle: Developer #1 creates `feature-x` branch from `main`
2. :large_blue_circle: Developer #1 clones `feature-x` branch to their local machine
3. :large_blue_circle: Developer #1 makes changes to the source code
4. :large_blue_circle: Developer #1 regularly pulls changes from `main` to `feature-x` branch
5. :large_blue_circle: Developer #1 regularly commits and pushes changes to `feature-x` branch
6. :green_circle: Developer #2 creates `feature-y` branch from `main`
7. :green_circle: Developer #2 clones `feature-y` branch to their local machine
8. :green_circle: Developer #2 makes changes to the source code
9. :green_circle: Developer #2 regularly pulls changes from `main` to `feature-y` branch
10. :green_circle: Developer #2 regularly commits and pushes changes to `feature-y` branch
11. :green_circle: Developer #2 creates a pull request to merge `feature-y` branch into `main`
12. :green_circle: CI workflows are triggered to validate, test, and build the source code
13. :green_circle: Reviewer receives a notification to review the pull request based on the `CODEOWNERS` file
14. :green_circle: Reviewer reviews the pull request and approves it
15. :green_circle: `feature-y` branch is merged into `main`
16. :green_circle: `feature-y` branch is deleted
17. :green_circle: CD workflows are triggered
18. :green_circle: A release/tag is created
19. :large_blue_circle: Developer #1 regularly pulls changes from `main` to `feature-x` branch (now includes the changes from `feature-y` branch)
20. :large_blue_circle: Developer #1 creates a pull request to merge `feature-x` branch into `main`
21. :large_blue_circle: CI workflows are triggered to validate, test, and build the source code
22. :large_blue_circle: Reviewer receives a notification to review the pull request based on the `CODEOWNERS` file
23. :large_blue_circle: Reviewer reviews the pull request and approves it
24. :large_blue_circle: `feature-x` branch is merged into `main`
25. :large_blue_circle: `feature-x` branch is deleted
26. :large_blue_circle: CD workflows are triggered
27. :large_blue_circle: A release/tag is created

---

### Production Hotfix

![Hotfix](./img/pr-hotfix.png)

:bulb: The `hotfix` branch is a special branch that has protection rules similar to `main` branch.

Developer #1 is working on `feature-x` branch and Developer #2 is working on `hotfix` branch.

1. :large_blue_circle: Developer #1 creates `feature-x` branch from `main`
2. :large_blue_circle: Developer #1 clones `feature-x` branch to their local machine
3. :large_blue_circle: Developer #1 makes changes to the source code
4. :large_blue_circle: Developer #1 regularly pulls changes from `main` to `feature-x` branch
5. :large_blue_circle: Developer #1 regularly commits and pushes changes to `feature-x` branch
6. :yellow_circle: Developer #2 creates `hotfix` branch from the latest `tag`
7. :yellow_circle: Developer #2 clones `hotfix` branch to their local machine
8. :yellow_circle: Developer #2 makes changes to the source code
9. ~~:yellow_circle: Developer #2 regularly pulls changes from `main` to `hotfix` branch~~
10. :yellow_circle: Developer #2 regularly commits and pushes changes to `hotfix` branch
11. :yellow_circle: Developer #2 creates a pull request to merge `hotfix` branch into `main`
12. :yellow_circle: CI workflows are triggered to validate, test, and build the source code
13. :yellow_circle: Reviewer receives a notification to review the pull request based on the `CODEOWNERS` file
14. :yellow_circle: Reviewer reviews the pull request and approves it
15. :yellow_circle: CD workflows are triggered **manually**
16. :yellow_circle: `hotfix` branch is merged into `main`
17. :yellow_circle: `hotfix` branch is deleted
18. :yellow_circle: CD workflows are **canceled**
19. :yellow_circle: A release/tag is **manually** created
20. :large_blue_circle: Developer #1 regularly pulls changes from `main` to `feature-x` branch (now includes the changes from `hotfix` branch)
21. :large_blue_circle: Developer #1 creates a pull request to merge `feature-x` branch into `main`
22. :large_blue_circle: CI workflows are triggered to validate, test, and build the source code
23. :large_blue_circle: Reviewer receives a notification to review the pull request based on the `CODEOWNERS` file
24. :large_blue_circle: Reviewer reviews the pull request and approves it
25. :large_blue_circle: `feature-x` branch is merged into `main`
26. :large_blue_circle: `feature-x` branch is deleted
27. :large_blue_circle: CD workflows are triggered
28. :large_blue_circle: A release/tag is created

## Terraform

1. Platform Engineer creates `feature` branch from `main`
2. Platform Engineer clones `feature` branch to their local machine
3. Platform Engineer creates/makes changes to the source code
4. Platform Engineer regularly pulls changes from `main` to `feature` branch
5. Platform Engineer regularly commits and pushes changes to `feature` branch
6. Platform Engineer creates a pull request to merge `feature` branch into `main`
7. A workflow is triggered to check if the `feature` branch is up to date with `main`
8. A workflow is triggered to validate the Terraform code
9. Reviewer receives a notification to review the pull request based on the `CODEOWNERS` file
10. Reviewer reviews the pull request and approves it
11. `feature` branch is merged into `main`
12. `feature` branch is deleted
13. A workflow is triggered to deploy the Terraform changes
14. A release/tag is created

## Azure Data Factory (ADF)

### Files

The [`adf/deployment/config-dev.csv`](../adf/deployment/config-dev.csv) is the configuration file for the ADF deployment. The file contains the list of ADF resources to be configured and deployed to the ADF per environment.

For new environments, create `adf/deployment/config-{env}.csv` file and update with the values for that environment.

[azure.datafactory.tools](https://github.com/Azure-Player/azure.datafactory.tools) is used to deploy the ADF resources.

1. Data Engineer creates `feature` branch from `main` in ADF
2. Data Engineer creates/updates to an ADF pipeline
3. Data Engineer creates/updates the [`adf/deployment/config-dev.csv/`](../adf/deployment/config-dev.csv)
4. Data Engineer regularly pulls changes from `main` to `feature` branch
5. Data Engineer regularly commits and pushes changes to `feature` branch
6. Data Engineer creates a pull request to merge `feature` branch into `main`
7. A workflow is triggered to check if the `feature` branch is up to date with `main`
8. Reviewer receives a notification to review the pull request based on the `CODEOWNERS` file
9. Reviewer reviews the pull request and approves it
10. `feature` branch is merged into `main`
11. `feature` branch is deleted
12. A workflow is triggered to deploy the ADF pipeline
13. A release/tag is created

### SQL

The [`adf/sql/dev.csv`](../adf/sql/dev.csv) is the configuration file for the `controldb` database deployment. The file contains the list of rows that will populate the `[control].[DB_DataSourceControl]` table.

For new environments, create `adf/sql/{env}.csv` file and update with the values for that environment.

[`adf/sql/script.sql`](../adf/sql/script.sql) is the SQL script that will be executed to populate the `[control].[DB_DataSourceControl]` table.

1. Data Engineer creates `feature` branch from `main`
2. Data Engineer creates/updates the [`adf/sql/dev.csv`](../adf/sql/dev.csv)
3. Data Engineer regularly pulls changes from `main` to `feature` branch
4. Data Engineer regularly commits and pushes changes to `feature` branch
5. Data Engineer creates a pull request to merge `feature` branch into `main`
6. A workflow is triggered to check if the `feature` branch is up to date with `main`
7. Reviewer receives a notification to review the pull request based on the `CODEOWNERS` file
8. Reviewer reviews the pull request and approves it
9. `feature` branch is merged into `main`
10. `feature` branch is deleted
11. A workflow is triggered to deploy the ADF pipeline
12. A release/tag is created

## Databricks

### Notebooks

1. Data Engineer creates `feature` branch from `main` in Databricks
2. Data Engineer creates/updates to a notebook
3. Data Engineer regularly pulls changes from `main` to `feature` branch
4. Data Engineer regularly commits and pushes changes to `feature` branch
5. Data Engineer creates a pull request to merge `feature` branch into `main`
6. A workflow is triggered to check if the `feature` branch is up to date with `main`
7. Reviewer receives a notification to review the pull request based on the `CODEOWNERS` file
8. Reviewer reviews the pull request and approves it
9. `feature` branch is merged into `main`
10. `feature` branch is deleted
11. A workflow is triggered to deploy the notebook
12. A release/tag is created

### Pipelines

The [`terraform/databricks`](../terraform/databricks) folder contains the Terraform code to deploy the Databricks pipelines.

1.  :green_circle: Data Engineer creates `feature` branch from `main` in Databricks
2.  :green_circle: Data Engineer creates/updates to a notebook
3.  :green_circle: Data Engineer creates/updates to a pipeline
4.  :green_circle: Data Engineer regularly pulls changes from `main` to `feature` branch
5.  :green_circle: Data Engineer regularly commits and pushes changes to `feature` branch
6.  :green_circle: Data Engineer notifies Platform Engineer to create/update the pipeline changes in Terraform
7.  :large_blue_circle: Platform Engineer clones `feature` branch
8.  :large_blue_circle: Platform Engineer creates/updates Terraform code for Databricks to deploy the pipeline changes in [`terraform/databricks`](../terraform/databricks)
9.  :large_blue_circle: Platform Engineer regularly pulls changes from `main` to `feature` branch
10. :large_blue_circle: Platform Engineer regularly commits and pushes changes to `feature` branch
11. :large_blue_circle: Platform Engineer notifies Data Engineer to create a pull request to merge `feature` branch into `main`
12. :green_circle: Data Engineer creates a pull request to merge `feature` branch into `main`
13. A workflow is triggered to check if the `feature` branch is up to date with `main`
14. Reviewer receives a notification to review the pull request based on the `CODEOWNERS` file
15. Reviewer reviews the pull request and approves it
16. `feature` branch is merged into `main`
17. `feature` branch is deleted
18. A workflow is triggered to deploy the notebook and the pipeline
19. A release/tag is created

## Workflows

All deployment resources are located in the [`.github`](../.github) folder.

```
.
├── actions
│   ├── tf-add-network-rules
│   │   └── action.yml
│   └── tf-remove-network-rules
│       └── action.yml
├── workflows
│   ├── adf-files.yml
│   ├── adf-sql.yml
│   ├── databricks-files.yml
│   ├── deploy-env.yml
│   ├── deploy-platform.yml
│   ├── diff-branch.yml
│   ├── terraform-apply.yml
│   ├── terraform-plan.yml
│   └── terraform-validate.yml
├── CODEOWNERS
└── pull_request_template.md
```

When a pull request is created, the CI workflows are triggered based on the path of the pull request, then once the pull request is approve and merged into `main`, the CD workflows are triggered.

The following is the list of workflows:

| Name                                                                  | Description                                  | Type              | Triggered By        |
| --------------------------------------------------------------------- | -------------------------------------------- | ----------------- | ------------------- |
| [adf-files.yml](../.github/workflows/adf-files.yml)                   | Publishes the ADF files                      | Reusable Workflow | deploy-env.yml      |
| [adf-sql.yml](../.github/workflows/adf-sql.yml)                       | Publishes the ADF SQL                        | Reusable Workflow | deploy-env.yml      |
| [databricks-files.yml](../.github/workflows/databricks-files.yml)     | Publishes the Databricks files               | Reusable Workflow | deploy-env.yml      |
| [deploy-env.yml](../.github/workflows/deploy-env.yml)                 | Deploys the environment                      | Reusable Workflow | deploy-platform.yml |
| [deploy-platform.yml](../.github/workflows/deploy-platform.yml)       | Deploys the platform                         | CD Workflow       | Merge into `main`   |
| [diff-branch.yml](../.github/workflows/diff-branch.yml)               | Checks if the branch is up to date with main | CI Workflow       | Pull Request        |
| [terraform-apply.yml](../.github/workflows/terraform-apply.yml)       | Applies the Terraform changes                | Reusable Workflow | deploy-env.yml      |
| [terraform-plan.yml](../.github/workflows/terraform-plan.yml)         | Plans the Terraform changes                  | Reusable Workflow | deploy-env.yml      |
| [terraform-validate.yml](../.github/workflows/terraform-validate.yml) | Validates the Terraform code (checkov)       | CI Workflow       | Pull Request        |

### Deployment Workflow

![Deployment Workflow](./img/workflow-deployment.png)

---

## Checkov Terraform Policies

[Checkov](https://www.checkov.io/) is a static code analysis tool for scanning infrastructure as code (IaC) files for misconfigurations that may lead to security or compliance problems. Checkov includes more than 750 predefined policies to check for common misconfiguration issues. Checkov also supports the creation and contribution of custom policies.

The the list of Checkov policies that are currently implemented are located in the [`.github/workflows/terraform-validate.yml`](../.github/workflows/terraform-validate.yml) workflow.

[Checkov Terraform Policies](https://www.checkov.io/5.Policy%20Index/terraform.html)
