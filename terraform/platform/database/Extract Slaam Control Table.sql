DECLARE @RAWADLSNAME VARCHAR(500)
DECLARE @RAWCONTAINER VARCHAR(200)
DECLARE @SOURCESYSTEM VARCHAR(100)
DECLARE @SOURCETYPE VARCHAR(100)
DECLARE @SOURCESERVERNAME VARCHAR(500)
DECLARE @SOURCEDB VARCHAR(100)
SELECT	@RAWADLSNAME = 'https://dlsanasboxcent01.dfs.core.windows.net', @RAWCONTAINER = 'analyticsextract', @SOURCESYSTEM='sandbox', 
		@SOURCETYPE = 'Azure SQL', @SOURCESERVERNAME ='ana-sbox-0sql-ana-dv-cent.database.windows.net',@SOURCEDB ='slalomtemp'

SELECT	@SOURCESYSTEM as SourceSystemName, 
		@SOURCETYPE as SourceSystemType,
		@SOURCESERVERNAME as SourceServerName,
		@SOURCEDB as SourceDBName,
		schemas.name as SourceSchemaName,
		objects.name as SourceTableName,
		--* as SourceTableColumnList,
		column_list.field_list as [SourceTableColumnList],
		case 
			WHEN charindex('_DELETE', objects.name) > 0 THEN 'CreatedOn'
			when (select count(*) from sys.columns where columns.name like 'LastChangedOn' and columns.object_id = objects.object_id) = 1 then 'LastChangedOn'
			when (select count(*) from sys.columns where columns.name like 'ModifiedOn' and columns.object_id = objects.object_id) = 1 then 'ModifiedOn'
			else 'N/A'
		end as [SourceTableIncrementalColumnName],
		'' as SourceUserName,
		'' as SourcePWSecretName,
		@RAWADLSNAME AS [RawAdlsUrlName],
		@RAWCONTAINER AS [RawContainerName],
		'csv' AS [RawFileExtension],
		'1' AS [IsActiveFlag],
		case 
			WHEN charindex('_DELETE', objects.name) > 0 THEN 'Incremental'
			when (select count(*) from sys.columns where columns.name like 'LastChangedOn' and columns.object_id = objects.object_id) = 1 then 'Incremental'
			when (select count(*) from sys.columns where columns.name like 'ModifiedOn' and columns.object_id = objects.object_id) = 1 then 'Incremental'
			else 'Full'
		end	 AS [LoadType]
FROM SYS.OBJECTS inner join sys.schemas
		on objects.schema_id = schemas.schema_id
	inner join 
	(
	SELECT object_id, STRING_AGG(
		case	when max_length = -1 then 'CAST(' + NAME + ' AS VARCHAR(4000)) as ' + name 
				when TYPE_NAME(system_type_id) = 'text' then  'CAST(' + NAME + '  AS VARCHAR(4000)) as ' + name 
				when  TYPE_NAME(system_type_id) = 'image'  then  'CAST(' + NAME + '  AS VARCHAR(4000)) as ' + name 
				when  TYPE_NAME(system_type_id) = 'bit'  then  'CAST(' + NAME + '  AS VARCHAR(1)) as ' + name 			
			else '['+name +']'
		end, ', ') WITHIN GROUP (ORDER BY column_id) as FIELD_LIST FROM SYS.COLUMNS 
	--where (TYPE_NAME(system_type_id) not in ('text','image'))
	--AND ((TYPE_NAME(system_type_id) not in ('varchar','varbinary') and max_length <> -1))
	group by object_id
	) column_list
	on objects.object_id = column_list.object_id
WHERE TYPE = 'U'
ORDER BY OBJECTS.NAME 


SELECT OBJECTS.NAME TableName, TableColumns.*
from 
(
	SELECT object_id, columns.name ColumnName,  TYPE_NAME(system_type_id) as SourceDataType,  STRING_AGG(
		case	when max_length = -1 then 'CAST(' + NAME + ' AS VARCHAR(4000)) as ' + name 
				when TYPE_NAME(system_type_id) = 'text' then  'CAST(' + NAME + '  AS VARCHAR(4000)) as ' + name 
				when  TYPE_NAME(system_type_id) = 'image'  then  'CAST(' + NAME + '  AS VARCHAR(4000)) as ' + name 
				when  TYPE_NAME(system_type_id) = 'bit'  then  'CAST(' + NAME + '  AS VARCHAR(1)) as ' + name 			
			else '['+name +']'
		end, ', ')  WITHIN GROUP (ORDER BY column_id) as FIELD_LIST FROM SYS.COLUMNS 
	where (TYPE_NAME(system_type_id) in ('text','image'))
	or ((TYPE_NAME(system_type_id) in ('varchar','varbinary') and max_length = -1))
	or (TYPE_NAME(system_type_id) = 'bit')
	group by object_id, TYPE_NAME(system_type_id),columns.name
) TableColumns INNER JOIN SYS.OBJECTS 
	ON TableColumns.OBJECT_ID = OBJECTS.OBJECT_ID 