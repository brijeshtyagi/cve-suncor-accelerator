# https://learn.microsoft.com/en-us/azure/databricks/data-governance/unity-catalog/automate

data "azurerm_resource_group" "rg" {
  name = var.resource_group_name
}

data "azapi_resource" "access_connector" {
  type                   = "Microsoft.Databricks/accessConnectors@2022-04-01-preview"
  name                   = var.access_connector_name
  parent_id              = data.azurerm_resource_group.rg.id
  response_export_values = ["id"]
}

resource "databricks_metastore" "metastore" {
  name          = var.metastore_name
  storage_root  = "abfss://${var.metastore_container_name}@${var.storage_account_name}.dfs.core.windows.net/"
  force_destroy = true
  owner         = var.metastore_user_group_name
}

resource "databricks_metastore_assignment" "default_metastore" {
  default_catalog_name = var.metastore_catalog_name
  metastore_id         = databricks_metastore.metastore.id
  workspace_id         = data.azurerm_databricks_workspace.dbw.workspace_id

  depends_on = [databricks_metastore.metastore]
}

resource "databricks_metastore_data_access" "metastore_data_access" {
  metastore_id = databricks_metastore.metastore.id
  name         = databricks_metastore.metastore.name
  is_default   = true

  azure_managed_identity {
    access_connector_id = data.azapi_resource.access_connector.id
  }

  depends_on = [databricks_metastore.metastore, databricks_metastore_assignment.default_metastore]
}

resource "databricks_catalog" "catalog" {
  metastore_id = databricks_metastore.metastore.id
  name         = var.metastore_catalog_name

  depends_on = [databricks_metastore_data_access.metastore_data_access]
}

resource "databricks_grants" "catalog" {
  catalog = databricks_metastore_assignment.default_metastore.default_catalog_name
  grant {
    principal  = var.metastore_user_group_name
    privileges = ["ALL_PRIVILEGES"]
  }

  depends_on = [databricks_catalog.catalog]
}

resource "databricks_schema" "schema" {
  name         = var.metastore_schema_name
  catalog_name = databricks_metastore_assignment.default_metastore.default_catalog_name

  depends_on = [databricks_catalog.catalog]
}
