resource "databricks_pipeline" "address_bronze" {
  name        = "Address_Source_Bronze"
  target      = "suncor_bronze"
  development = true
  continuous  = false
  photon      = true
  serverless  = false

  configuration = {
    config_file_path : "/Workspace/Shared/databricks/config/suncor_poc.yaml"
  }

  cluster {
    label      = "default"
    spark_conf = local.spark_conf
    autoscale {
      min_workers = 1
      max_workers = 5
    }
  }

  library {
    notebook {
      path = "/Shared/databricks/bronze/source_to_bronze_pl"
    }
  }
}

resource "databricks_pipeline" "address_silver" {
  name        = "Address_Bronze_Silver"
  target      = "suncor_silver"
  development = true
  continuous  = false
  photon      = true
  serverless  = false

  configuration = {
    config_file_path : "/Workspace/Shared/databricks/config/suncor_poc.yaml"
  }

  cluster {
    label      = "default"
    spark_conf = local.spark_conf
    autoscale {
      min_workers = 1
      max_workers = 5
    }
  }

  library {
    notebook {
      path = "/Shared/databricks/silver/bronze_to_silver_pl"
    }
  }
}

resource "databricks_pipeline" "address_gold" {
  name        = "Address_Silver_Gold"
  target      = "suncor_gold"
  development = true
  continuous  = false
  photon      = true
  serverless  = false

  configuration = {
    config_file_path : "/Workspace/Shared/databricks/config/suncor_poc.yaml"
  }

  cluster {
    label      = "default"
    spark_conf = local.spark_conf
    autoscale {
      min_workers = 1
      max_workers = 5
    }
  }

  library {
    notebook {
      path = "/Shared/databricks/gold/silver_to_gold_pl"
    }
  }
}

resource "databricks_pipeline" "address_de_identification" {
  name        = "Address_Bronze_De_Identification"
  target      = "suncor_bronze"
  development = true
  continuous  = false
  photon      = true
  serverless  = false
  catalog     = "suncor_catalog"
  channel     = "PREVIEW"

  configuration = {
    config_file_path : "/Workspace/Shared/databricks/config/suncor_poc.yaml"
  }

  cluster {
    label      = "default"
    spark_conf = local.spark_conf
    autoscale {
      min_workers = 1
      max_workers = 5
    }
  }

  library {
    notebook {
      path = "/Shared/databricks/bronze/source_to_bronze_pl"
    }
  }
}
resource "databricks_job" "address" {
  name                = "Address"
  timeout_seconds     = 0
  max_concurrent_runs = 1

  task {
    task_key = databricks_pipeline.address_bronze.name
    pipeline_task {
      pipeline_id = databricks_pipeline.address_bronze.id
    }
  }

  task {
    task_key = databricks_pipeline.address_de_identification.name
    pipeline_task {
      pipeline_id = databricks_pipeline.address_de_identification.id
    }
    depends_on {
      task_key = databricks_pipeline.address_bronze.name
    }
  }

  task {
    task_key = databricks_pipeline.address_silver.name
    pipeline_task {
      pipeline_id = databricks_pipeline.address_silver.id
    }
    depends_on {
      task_key = databricks_pipeline.address_de_identification.name
    }
  }

  task {
    task_key = databricks_pipeline.address_gold.name
    pipeline_task {
      pipeline_id = databricks_pipeline.address_gold.id
    }
    depends_on {
      task_key = databricks_pipeline.address_silver.name
    }
  }
}
