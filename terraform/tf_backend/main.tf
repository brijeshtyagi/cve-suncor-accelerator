provider "azurerm" {
  features {
    key_vault {
      recover_soft_deleted_key_vaults = false
    }
  }
  skip_provider_registration = true
}

terraform {
  required_providers {
    azurerm = {
      source  = "hashicorp/azurerm"
      version = "3.66.0"
    }
  }

  backend "azurerm" {}
}

module "resource-group" {
  source   = "../modules/resource-group"
  name     = var.global_settings.rg_name
  location = var.global_settings.rg_location
  tags     = var.global_settings.tags
}

module "storage-account" {
  source                   = "../modules/storage-account"
  storage_account_name     = var.sa_config.name
  resource_group_name      = var.global_settings.rg_name
  location                 = var.global_settings.rg_location
  account_tier             = var.sa_config.tier
  is_hns_enabled           = var.sa_config.enabled_hierarchical_namespace
  account_replication_type = var.sa_config.replication_type
  containers_list          = var.sa_config.containers
  account_kind             = var.sa_config.kind
  network_rules            = var.sa_config.network_rules
  current_ip               = var.sa_config.network_rules != null ? var.current_ip : null
  tags                     = var.global_settings.tags

  depends_on = [module.resource-group]
}
