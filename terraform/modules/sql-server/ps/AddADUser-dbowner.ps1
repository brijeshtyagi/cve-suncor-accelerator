Param(
    [Parameter(Mandatory = $false)]
    [string]$accessToken,

    [Parameter(Mandatory = $true)]
    [string]$umi_client_id,

    [Parameter(Mandatory = $true)]
    [string]$azureADUser,

    [Parameter(Mandatory = $true)]
    [string]$SQLServerName,

    [Parameter(Mandatory = $true)]
    [string]$databaseName
)

if ([string]::IsNullOrEmpty($accessToken)) {
    Write-Output "GETTING TOKEN..."
    $accessToken = (az account get-access-token --resource=https://database.windows.net --query accessToken --output tsv)
    Write-Output "DONE"
}

Write-Output "PERFORMING SQL OPERATIONS..."
$conn = New-Object System.Data.SqlClient.SQLConnection
$conn.ConnectionString = "Data Source=$SQLServerName;Initial Catalog=$databaseName;Connect Timeout=30"
$conn.AccessToken = $($accessToken)

$appServiceServicePrincipal = $($umi_client_id)

try {
    $conn.Open()

    $query = "SELECT CONVERT(VARCHAR(1000), CAST(CAST('$($appServiceServicePrincipal)' AS UNIQUEIDENTIFIER) AS VARBINARY(16)),1);"

    $command = $conn.CreateCommand()
    $command.CommandText = $query
    $appServiceServicePrincipalSid = $command.ExecuteScalar()

    $query = "
        IF NOT EXISTS (
            SELECT  [name]
            FROM    sys.database_principals
            WHERE   [name] = '$($azureADUser)'
        )
        BEGIN
            CREATE USER [$($azureADUser)] WITH SID=$($appServiceServicePrincipalSid), TYPE=E
            ALTER ROLE db_owner ADD MEMBER [$($azureADUser)];
        END
    "

    $command = $conn.CreateCommand()

    try {
        $command.CommandText = $query
        $command.ExecuteNonQuery()
    }
    finally {
        if ($null -ne $command) {
            $command.Dispose()
        }
    }
}
finally {
    if ($conn.State -eq 'Open') {
        $conn.Close()
    }

    if ($null -ne $conn) {
        $conn.Dispose()
    }
}

Write-Output "DONE"