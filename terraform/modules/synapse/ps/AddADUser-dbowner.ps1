Param(
    [Parameter(Mandatory=$false)]
    [string]$accessToken,

    [Parameter(Mandatory=$true)]
    [string]$umi_client_id,
    
    [Parameter(Mandatory=$true)]
    [string]$azureADUser,

    [Parameter(Mandatory=$true)]
    [string]$SQLServerName,

    [Parameter(Mandatory=$true)]
    [string]$databaseName
)

if ($accessToken -eq $null)
{
    Write-Output "GETTING TOKEN..."
    $accessToken = (az account get-access-token --resource=https://database.windows.net --query accessToken --output tsv)
    Write-Output "DONE"
}

Write-Output "PERFORMING SQL OPERATIONS..."
$conn = New-Object System.Data.SqlClient.SQLConnection 
$conn.ConnectionString = "Data Source=tcp:$SQLServerName.sql.azuresynapse.net,1433;Initial Catalog=$databaseName;Persist Security Info=False;MultipleActiveResultSets=False;Encrypt=True;TrustServerCertificate=False;Connection Timeout=30"
$conn.AccessToken = $($accessToken)

$appServiceServicePrincipal = $($umi_client_id)

try 
    {
        $conn.Open() 

$query =@"
SELECT CONVERT(VARCHAR(1000), CAST(CAST('$($appServiceServicePrincipal)' AS UNIQUEIDENTIFIER) AS VARBINARY(16)),1);
"@

        $command = $conn.CreateCommand()
        $command.CommandText = $query
        $appServiceServicePrincipalSid = $command.ExecuteScalar()

$query =@"
            IF NOT EXISTS (
                SELECT  [name]
                FROM    sys.database_principals
                WHERE   [name] = '$($azureADUser)'
            )
            BEGIN
                CREATE USER [$($azureADUser)] WITH SID=$($appServiceServicePrincipalSid), TYPE=E
                EXEC sp_addrolemember db_owner, [$($azureADUser)];
            END
"@

        $command = $conn.CreateCommand()
        $command.CommandText = $query
        $command.ExecuteNonQuery()
    }
    finally 
    {
        $conn.Close()
        $command.Dispose()
        $conn.Dispose()
    }

Write-Output "DONE"